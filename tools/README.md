# tools for use with oshinko-rest

## server-template.yaml

This is a template that can be processed for adding an oshinko-rest
image to OpenShift. It maintains the default 0.0.0.0:8080 host:port option
for the server.

To use this template, an oshinko-rest image and a spark image must
first be tagged into the OpenShift project. Then the template must be
processed with the locations of the images. Finally, the output of the
processed template can be used to create the service and pod. Check
server-template.yaml to see the full list of parameters that may be
specified and their defaults.

## server-ui-template.yaml

This is an extension of the server-template.yaml above and includes the
oshinko-web-ui as well. This template requires that an oshinko-web-ui
image also be tagged into the OpenShift project. Setup of the service
account as described below and processing of the template is analogous
to what is described for server-template.yaml. Check server-ui-template.yaml
to see the full list of parameters that may be specified and their defaults.

## Service account

The oshinko-rest image uses an "oshinko" service account to perform openshift
operations. This service account must be created and given the admin role in
*each* project which will use the oshinko-rest image, for example:

Create a new project *myproject*:

    $ oc new-project myproject

Create the oshinko service account:

    $ more sa.json
    {
      "apiVersion": "v1",
      "kind": "ServiceAccount",
      "metadata": {
        "name": "oshinko"
      }
    }

    $ oc create -f sa.json

Assign the admin role:

    $ oc policy add-role-to-user admin system:serviceaccount:myproject:oshinko -n myproject

## Sample template usage

Example usage with an internal registry at 172.30.159.57:5000, and a project
named "myproject":

    $ oc process -f server-template.yaml -v OSHINKO_SERVER_IMAGE=172.30.159.57:5000/myproject/oshinko-rest,OSHINKO_CLUSTER_IMAGE=172.30.159.57:5000/myproject/openshift-spark > server-template.json
    $ oc create -f server-template.json

## Sample script to setup oshinko
Use oshinko-setup.sh to quickly deploy the oshinko bits into an OpenShift cluster.
The cluster is generated by downloading the OpenShift tarball and using
the `oc cluster up` command.

Example usage:

    $ oshinko-setup.sh -w mywebui.10.16.40.70.xip.io

This will setup a cluster and install oshinko with the oshinko web ui
accessible at mywebui.10.16.40.70.xip.io (using xip.io is a way to
get DNS to resolve to the IP, 10.16.40.70 in the example).  You would
need to use a routeable IP address of your machine.

    $ oshinko-setup.sh -w myweb.10.16.40.70.xip.io -s myregistry.com:5000/sparkimage

This will setup a cluster and install the oshinko bits as in the previous
example, but will use a custom Spark image that you specified with the
-s flag.  The custom image must use a built-in CMD (specified in the
Dockerfile) to start Spark and it must also expect an enviornment variable,
SPARK_MASTER_ADDRESS to be set in the worker nodes.  The oshinko rest server
will fill-in that value at spawn-time to be set to the address of the Spark
master node.  For the master node, that value will not be set.  The absence
of that value is what tells Spark to run as the master node.

It should be noted, that if you do not use a custom Spark image with
the -s flag, a Spark image will be built for you from the openshift-spark
repository.

### A note on permissions

Some of the operations in this script may require superuser privileges
depending on the configuration of your system and OpenShift deployment. In
specific, the usage of docker and the permissions for logging in as the
`system:admin` user in OpenShift are assumed. If these are not configured for
non-root access in your system, then you may need to invoke this script using
the `sudo` command or as the `root` user.

## Sample script to deploy oshinko

The `oshinko-deploy.sh` script can deploy the oshinko suite into an existing
OpenShift deployment or it can start an all-in-one docker OpenShift on the
host. It will pull the latest upstream images from the radanalyticsio
organization. It can also be configured to use alternate images, for more
information see the script help text.

**Example all-in-one deployment**

    $ ./oshinko-deploy.sh -d

This will start an OpenShift all-in-one cluster with the `oc cluster up`
command on the host, then it will deploy the oshinko suite into the
`myproject` project as user `developer`. It will apply the default route
url specified by OpenShift.

**Example deployment on remote cluster**

    $ ./oshinko-deploy.sh -c https://10.0.1.100:8443 \
                          -u bob \
                          -p bobsproject \
                          -o bobsoshinko.10.0.1.100.xip.io

This will deploy oshinko into the OpenShift cluster on the 10.0.1.100 host,
in the `bobsproject` project as user `bob`. It will apply the route url
`bobsoshinko.10.0.1.100.xip.io` to the oshinko web console.
